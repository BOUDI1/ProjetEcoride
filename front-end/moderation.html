<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>EcoRide - Mod√©ration</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo"><a href="index.html">EcoRide üåø</a></h1>
        </div>
    </header>

    <main class="container">
        <h2>üõ°Ô∏è Espace Mod√©ration</h2>

        <section class="mod-section">
            <h3>üí¨ Avis des voyageurs</h3>
            <div id="container-avis" class="results-grid">
                <p>Chargement des avis...</p>
            </div>
        </section>

        <hr style="margin: 40px 0;">

        <section class="mod-section">
            <h3>üöó Trajets en attente de validation</h3>
            <div id="container-trajets-admin" class="results-grid">
                <p>Chargement des trajets...</p>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 1. CHARGEMENT DES AVIS (Corrig√© pour correspondre √† ton JSON) ---
            async function chargerAvis() {
                const container = document.getElementById('container-avis');
                try {
                    const response = await fetch('../back-end/api/get_avis.php');
                    const result = await response.json();
                    
                    // On utilise 'data' au lieu de 'avis' car c'est ce que renvoie ton API
                    if (result.status === "success" && result.data.length > 0) {
                        container.innerHTML = result.data.map(a => `
                            <div class="card-trajet">
                                <p>"${a.commentaire}"</p>
                                <small>Par : <strong>${a.pseudo}</strong> - Note: ${a.note}/5</small>
                                <br>
                                <button onclick="supprimerAvis('${a.id}')" style="background:#e74c3c; color:white; border:none; padding:8px; margin-top:10px; border-radius:4px; cursor:pointer;">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = "<p>Aucun avis √† mod√©rer.</p>";
                    }
                } catch (e) { 
                    console.error("Erreur Avis:", e);
                    container.innerHTML = "<p>Erreur lors du chargement des avis.</p>"; 
                }
            }

            // --- 2. SUPPRESSION D'UN AVIS ---
            window.supprimerAvis = async (id) => {
                if(!confirm("Supprimer cet avis d√©finitivement ?")) return;
                try {
                    const response = await fetch('../back-end/api/manage_avis.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: id, action: 'delete' })
                    });
                    const res = await response.json();
                    alert(res.message || "Avis supprim√©");
                    chargerAvis(); // Recharger la liste
                } catch (e) { alert("Erreur lors de la suppression"); }
            };

            // --- 3. CHARGEMENT DES TRAJETS ---
            async function chargerTrajets() {
                const container = document.getElementById('container-trajets-admin');
                try {
                    const response = await fetch('../back-end/api/get_trajets_admin.php');
                    const data = await response.json();
                    
                    if (data.status === "success" && data.results && data.results.length > 0) {
                        container.innerHTML = data.results.map(t => `
                            <div class="card-trajet" style="border-top: 5px solid #f1c40f;">
                                <strong>${t.lieu_depart} ‚ûî ${t.lieu_arrivee}</strong>
                                <p>Chauffeur : ${t.prenom} | Date : ${t.date_depart}</p>
                                <div style="display:flex; gap:10px; margin-top:10px;">
                                    <button onclick="deciderTrajet(${t.id_covoiturage}, 'valider')" class="btn-primary" style="background:#2ecc71; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">Valider</button>
                                    <button onclick="deciderTrajet(${t.id_covoiturage}, 'refuser')" style="background:#e74c3c; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">Refuser</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = "<p>Aucun trajet en attente.</p>";
                    }
                } catch (e) { container.innerHTML = "<p>Erreur trajets.</p>"; }
            }

            // --- 4. ACTION VALIDER/REFUSER TRAJET ---
            window.deciderTrajet = async (id, action) => {
                if(!confirm(`Voulez-vous ${action} ce trajet ?`)) return;
                try {
                    const resp = await fetch('../back-end/api/valider_trajet.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id_covoiturage: id, action: action })
                    });
                    const res = await resp.json();
                    alert(res.message);
                    chargerTrajets(); 
                } catch (e) { alert("Erreur action"); }
            };

            // Lancement initial
            chargerAvis();
            chargerTrajets();
        });
    </script>
</body>
</html>